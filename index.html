<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Mini P.E.K.K.A.'s Pancake Clicker</title>    <!-- Load Tailwind CSS -->    <script src="https://cdn.tailwindcss.com"></script>    <style>        /* Custom styles for Clash Royale/Pekka theme */        body {            font-family: 'Inter', sans-serif;            background-color: #0d1117; /* Dark background */            min-height: 100vh;        }
        .pekka-button {            transition: transform 0.05s ease-out, box-shadow 0.1s ease-out;            cursor: pointer;            user-select: none;            border: 4px solid #fbc02d; /* Gold border */            box-shadow: 0 10px 20px rgba(126, 34, 206, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.2);        }
        .pekka-button:active {            transform: scale(0.98);            box-shadow: 0 5px 10px rgba(126, 34, 206, 0.8), inset 0 0 5px rgba(255, 255, 255, 0.4);        }
        .upgrade-card {            background-color: #1a202c; /* Dark card background */            border-left: 5px solid #7e22ce; /* Purple accent */            transition: transform 0.1s;        }
        .upgrade-card:hover {            transform: translateY(-2px);            box-shadow: 0 8px 15px rgba(126, 34, 206, 0.3);        }
        .upgrade-card:disabled {            opacity: 0.6;            cursor: not-allowed;            transform: none;        }
        .text-epic-purple {            color: #7e22ce;        }                .purchase-button {            background-image: linear-gradient(to right, #4c1d95, #7c3aed);            transition: all 0.2s;        }
        .purchase-button:hover:not(:disabled) {            background-image: linear-gradient(to right, #7c3aed, #a78bfa);            box-shadow: 0 4px 10px rgba(126, 34, 206, 0.5);        }
        .leaderboard-item:nth-child(1) { color: #FFD700; font-weight: bold; } /* Gold */        .leaderboard-item:nth-child(2) { color: #C0C0C0; } /* Silver */        .leaderboard-item:nth-child(3) { color: #CD7F32; } /* Bronze */

        /* Responsive font scaling for the clicker */        @media (max-width: 640px) {            .pekka-text {                font-size: 8rem; /* Large size for mobile touch target */            }            .score-text {                font-size: 3.5rem;            }        }        @media (min-width: 641px) {            .pekka-text {                font-size: 10rem;            }            .score-text {                font-size: 4.5rem;            }        }
    </style></head><body class="text-white">    <div class="max-w-4xl mx-auto p-4 flex flex-col items-center">        <!-- Firebase Status -->        <div id="auth-status" class="w-full text-center text-sm text-gray-500 mb-2">            Loading game data...        </div>
        <!-- Title and Scoreboard -->        <header class="w-full text-center mb-6">            <h1 class="text-5xl font-extrabold text-yellow-400 mt-4 mb-2">Mini P.E.K.K.A.'s Kitchen</h1>            <p class="text-lg text-gray-400 mb-4">Pancakes! Destroy Butterflies!</p>            <div id="score-display" class="bg-gray-800 p-4 rounded-xl shadow-lg border-2 border-purple-500">                <div class="score-text font-mono tracking-widest leading-none mb-2">                    <span id="pancakes-count">0.00</span>                 </div>                 <div class="text-3xl font-mono tracking-widest leading-none mb-2 text-cyan-400">                    <span id="gems-count">0</span>                 </div>                <div class="text-sm text-yellow-300 font-semibold mt-1">                    (<span id="pps-count">0.0</span> PPS)                </div>            </div>        </header>
        <!-- Main Clicker Area -->        <div class="mb-8 w-full flex justify-center">            <button id="pekka-clicker" class="pekka-button w-4/5 max-w-xs aspect-square rounded-full bg-purple-900 flex flex-col items-center justify-center p-4">                <span class="pekka-text leading-none transition-all duration-75 ease-out">                    <!-- Changed icon to represent Mini P.E.K.K.A. -->                </span>                <span class="text-xl font-bold text-yellow-300 -mt-4">+<span id="click-value-display">1</span> </span>            </button>        </div>
        <!-- Shop/Upgrade Section -->        <h2 class="text-3xl font-bold text-epic-purple mb-4 border-b-2 border-purple-600 pb-2 w-full text-center">The Troop Kitchen</h2>        <div id="shop" class="w-full grid grid-cols-1 gap-4">                        <!-- Upgrade Card: Buy Gem (NEW) -->            <div class="upgrade-card p-4 rounded-lg flex justify-between items-center" id="buyGem-card">                <div>                    <span class="text-3xl mr-3 text-cyan-400"> </span>                    <span class="text-xl font-semibold">Buy Gem</span>                    <p class="text-gray-400 text-sm">Convert Pancakes into Gems to climb the Gem Leaderboard! (1 Gem)</p>                </div>                <button class="purchase-button text-sm font-bold py-2 px-4 rounded-full" onclick="buyGem()" id="buy-gem">                    Buy (10K )                </button>            </div>
            <!-- Upgrade Card 4: Mega Knight Multiplier -->            <div class="upgrade-card p-4 rounded-lg flex justify-between items-center" id="megaKnight-card">                <div>                    <span class="text-3xl mr-3 text-red-500"> </span>                    <span class="text-xl font-semibold">Mega Knight Drop</span>                    <p class="text-gray-400 text-sm">Jumps down and multiplies ALL earnings (PPS & Click) by x5! (One-time)</p>                    <p class="text-sm text-yellow-500">Active: <span id="megaKnight-count">No</span></p>                </div>                <button class="purchase-button text-sm font-bold py-2 px-4 rounded-full" onclick="buyTroop('megaKnight')" id="buy-megaKnight">                    Buy (100K )                </button>            </div>
            <!-- Upgrade Card 5: Auto Clicker -->            <div class="upgrade-card p-4 rounded-lg flex justify-between items-center" id="autoclicker-card">                <div>                    <span class="text-3xl mr-3 text-blue-400"> </span>                    <span class="text-xl font-semibold">Premium AFK Clicker</span>                    <p class="text-gray-400 text-sm">Simulates one manual click per second while you're away. (One-time)</p>                </div>                <button class="purchase-button text-sm font-bold py-2 px-4 rounded-full" onclick="buyAutoClicker()" id="buy-autoclicker">                    Buy (39.9K )                </button>            </div>
            <!-- Standard Troop Upgrades -->            <div class="upgrade-card p-4 rounded-lg flex justify-between items-center" data-troop="goblin">                <div>                    <span class="text-3xl mr-3"> </span>                    <span class="text-xl font-semibold">Goblin Rush</span>                    <p class="text-gray-400 text-sm">A quick stab of flavor. (+0.2 PPS)</p>                    <p class="text-sm text-yellow-500">Owned: <span class="troop-count" id="goblin-count">0</span></p>                </div>                <button class="purchase-button text-sm font-bold py-2 px-4 rounded-full" onclick="buyTroop('goblin')" id="buy-goblin">                    Buy (<span class="troop-cost" id="goblin-cost">10</span> )                </button>            </div>
            <div class="upgrade-card p-4 rounded-lg flex justify-between items-center" data-troop="wizard">                <div>                    <span class="text-3xl mr-3"> </span>                    <span class="text-xl font-semibold">Fireball Fry</span>                    <p class="text-gray-400 text-sm">Magic cooking power! (+2.0 PPS)</p>                    <p class="text-sm text-yellow-500">Owned: <span class="troop-count" id="wizard-count">0</span></p>                </div>                <button class="purchase-button text-sm font-bold py-2 px-4 rounded-full" onclick="buyTroop('wizard')" id="buy-wizard">                    Buy (<span class="troop-cost" id="wizard-cost">100</span> )                </button>            </div>
            <div class="upgrade-card p-4 rounded-lg flex justify-between items-center" data-troop="pekka">                <div>                    <span class="text-3xl mr-3"> </span>                    <span class="text-xl font-semibold">P.E.K.K.A. Master Chef</span>                    <p class="text-gray-400 text-sm">Now that's a lot of butter! (+20.0 PPS)</p>                    <p class="text-sm text-yellow-500">Owned: <span class="troop-count" id="pekka-count">0</span></p>                </div>                <button class="purchase-button text-sm font-bold py-2 px-4 rounded-full" onclick="buyTroop('pekka')" id="buy-pekka">                    Buy (<span class="troop-cost" id="pekka-cost">1000</span> )                </button>            </div>
        </div>
        ---                <!-- Leaderboard Section (NEW) -->        <h2 class="text-3xl font-bold text-yellow-400 mt-8 mb-4 border-b-2 border-yellow-600 pb-2 w-full text-center">Global Leaderboards</h2>        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">                        <!-- Pancake Leaderboard -->            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border-2 border-yellow-500">                <h3 class="text-xl font-bold text-yellow-400 mb-3 text-center">Top 10 Pancakes </h3>                <ol id="pancake-leaderboard" class="space-y-2 text-lg">                    <!-- Leaderboard items will be inserted here by JS -->                    <li class="text-gray-400">Loading...</li>                </ol>            </div>
            <!-- Gem Leaderboard -->            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border-2 border-cyan-400">                <h3 class="text-xl font-bold text-cyan-400 mb-3 text-center">Top 10 Gems </h3>                <ol id="gem-leaderboard" class="space-y-2 text-lg">                    <!-- Leaderboard items will be inserted here by JS -->                    <li class="text-gray-400">Loading...</li>                </ol>            </div>
        </div>                <!-- Reset Button and Info -->        <footer class="mt-8 w-full text-center">            <button id="reset-button" class="text-red-400 hover:text-red-500 text-sm p-2 rounded-lg transition-colors border border-red-400 hover:border-red-500" onclick="resetGame()">                RESET GAME (DANGER!)            </button>            <div id="message-box" class="mt-4 p-3 bg-red-800 text-red-100 rounded-lg hidden"></div>        </footer>    </div>
    <script type="module">        // --- FIREBASE IMPORTS ---        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";                // setLogLevel('debug'); // Uncomment for debugging Firestore                // --- FIREBASE GLOBAL VARS ---        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;                let app, db, auth, currentUserId = null;        let authReady = false;
        // --- GAME STATE & INITIALIZATION ---
        let gameState = {            pancakes: 0,            gems: 0, // NEW            baseClickValue: 1,            clickValue: 1,            pps: 0,            autoClickerActive: false,            megaKnightMultiplier: 1,            username: `MiniCooker_${Math.floor(Math.random() * 9000) + 1000}`, // Simple default username            troops: {                goblin: { count: 0, baseCost: 10, costMultiplier: 1.15, ppsPerUnit: 0.2 },                wizard: { count: 0, baseCost: 100, costMultiplier: 1.25, ppsPerUnit: 2.0 },                pekka: { count: 0, baseCost: 1000, costMultiplier: 1.35, ppsPerUnit: 20.0 }            },            // Special one-time upgrade costs            megaKnightCost: 100000,            autoClickerCost: 39900,            gemCost: 10000 // NEW cost to buy 1 gem        };
        // DOM Elements        const $pancakesCount = document.getElementById('pancakes-count');        const $gemsCount = document.getElementById('gems-count');        const $ppsCount = document.getElementById('pps-count');        const $clickValueDisplay = document.getElementById('click-value-display');        const $pekkaClicker = document.getElementById('pekka-clicker');        const $messageBox = document.getElementById('message-box');        const $authStatus = document.getElementById('auth-status');        const $pancakeLeaderboard = document.getElementById('pancake-leaderboard');        const $gemLeaderboard = document.getElementById('gem-leaderboard');                const MEGA_KNIGHT_MULTIPLIER_VALUE = 5;
        // --- FIREBASE INITIALIZATION & AUTH ---
        function initFirebase() {            try {                app = initializeApp(firebaseConfig);                db = getFirestore(app);                auth = getAuth(app);                                // Set persistence to local to remember the user                setPersistence(auth, browserLocalPersistence)                    .then(() => {                        return initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth);                    })                    .catch((error) => {                        console.error("Auth error:", error);                        $authStatus.textContent = `Error signing in.`;                    });
                onAuthStateChanged(auth, (user) => {                    if (user) {                        currentUserId = user.uid;                        $authStatus.textContent = `User ID: ${currentUserId}`;                        loadGameData(currentUserId);                        setupLeaderboardListener();                    } else {                        console.log("No user signed in.");                        $authStatus.textContent = `Signed in anonymously.`;                        authReady = true; // Still allow game to run anonymously, but won't save/load                        updateDisplay();                    }                });
            } catch (error) {                console.error("Firebase Initialization Error:", error);                $authStatus.textContent = "Firebase is unavailable.";            }        }
        // --- FIRESTORE DATA HANDLING ---
        function getPlayerDocRef(userId) {             return doc(db, "artifacts", appId, "users", userId, "game_data", "main");        }
        function getLeaderboardCollectionRef() {            return collection(db, "artifacts", appId, "public", "data", "leaderboard_players");        }                async function loadGameData(userId) {            if (!db) return;            const docRef = getPlayerDocRef(userId);
            try {                const docSnap = await getDoc(docRef);                if (docSnap.exists()) {                    const loadedState = docSnap.data();                    // Load and merge state                    gameState.pancakes = loadedState.pancakes || 0;                    gameState.gems = loadedState.gems || 0; // Load Gems                    gameState.baseClickValue = loadedState.baseClickValue || 1;                    gameState.troops.goblin.count = loadedState.troops.goblin?.count || 0;                    gameState.troops.wizard.count = loadedState.troops.wizard?.count || 0;                    gameState.troops.pekka.count = loadedState.troops.pekka?.count || 0;                    gameState.autoClickerActive = loadedState.autoClickerActive || false;                    gameState.megaKnightMultiplier = loadedState.megaKnightMultiplier || 1;                    gameState.username = loadedState.username || gameState.username; // Keep existing username if none saved
                } else {                    // New player: Save initial state                    await savePlayerStateToFirestore();                }            } catch (e) {                console.error("Error loading game state:", e);            }
            authReady = true;            calculateStats();            updateDisplay();        }
        async function savePlayerStateToFirestore() {            if (!db || !currentUserId) return;            const docRef = getPlayerDocRef(currentUserId);            const leaderboardDocRef = doc(getLeaderboardCollectionRef(), currentUserId);
            const stateToSave = {                pancakes: gameState.pancakes,                gems: gameState.gems, // Save Gems                baseClickValue: gameState.baseClickValue,                autoClickerActive: gameState.autoClickerActive,                megaKnightMultiplier: gameState.megaKnightMultiplier,                username: gameState.username,                troops: {                    goblin: { count: gameState.troops.goblin.count },                    wizard: { count: gameState.troops.wizard.count },                    pekka: { count: gameState.troops.pekka.count }                }            };                        // Save private game data            try {                await setDoc(docRef, stateToSave);            } catch (e) {                console.error("Error saving game state:", e);            }
            // Save public leaderboard data            const leaderboardData = {                userId: currentUserId,                username: gameState.username,                pancakes: Math.floor(gameState.pancakes),                gems: gameState.gems            };
            try {                await setDoc(leaderboardDocRef, leaderboardData, { merge: true });            } catch (e) {                console.error("Error saving leaderboard data:", e);            }        }                // --- LEADERBOARD LOGIC (NEW) ---
        function setupLeaderboardListener() {            if (!db) return;
            const q = collection(db, "artifacts", appId, "public", "data", "leaderboard_players");                        // Listen to all players and sort locally for the top 10            onSnapshot(q, (snapshot) => {                const players = [];                snapshot.forEach((doc) => {                    players.push(doc.data());                });
                updateLeaderboardUI(players);            }, (error) => {                console.error("Leaderboard snapshot error:", error);                $pancakeLeaderboard.innerHTML = '<li class="text-red-400">Error loading leaderboard.</li>';                $gemLeaderboard.innerHTML = '<li class="text-red-400">Error loading leaderboard.</li>';            });        }
        function updateLeaderboardUI(players) {                        // 1. Pancake Leaderboard (Sort descending)            const pancakeRankings = players.sort((a, b) => b.pancakes - a.pancakes).slice(0, 10);            renderLeaderboard($pancakeLeaderboard, pancakeRankings, 'pancakes', ' ');
            // 2. Gem Leaderboard (Sort descending)            const gemRankings = players.sort((a, b) => b.gems - a.gems).slice(0, 10);            renderLeaderboard($gemLeaderboard, gemRankings, 'gems', ' ');        }
        function renderLeaderboard(containerEl, rankings, metric, symbol) {            containerEl.innerHTML = '';            rankings.forEach((player, index) => {                const li = document.createElement('li');                li.className = `leaderboard-item flex justify-between items-center text-gray-200 ${player.userId === currentUserId ? 'bg-purple-800 p-1 rounded' : ''}`;                                const value = metric === 'pancakes' ? formatNumber(player.pancakes, 0) : formatNumber(player.gems, 0);
                li.innerHTML = `                    <span class="font-bold w-6">${index + 1}.</span>                     <span class="truncate flex-1 ml-2">${player.username}</span>                     <span class="font-mono text-right ml-4">${value} ${symbol}</span>                `;                containerEl.appendChild(li);            });
            if (rankings.length === 0) {                 containerEl.innerHTML = '<li class="text-gray-400">No players ranked yet.</li>';            }        }

        // --- GAME LOGIC ---
        function calculateCost(baseCost, count, multiplier) {            return Math.floor(baseCost * Math.pow(multiplier, count));        }
        function calculateStats() {            // 1. Calculate Base PPS (before multiplier)            let basePps = 0;            for (const troopName in gameState.troops) {                const troop = gameState.troops[troopName];                basePps += troop.count * troop.ppsPerUnit;            }
            // 2. Apply Mega Knight Multiplier to all earnings            gameState.pps = basePps * gameState.megaKnightMultiplier;            gameState.clickValue = gameState.baseClickValue * gameState.megaKnightMultiplier;
            // 3. Update standard troop costs and UI            for (const troopName in gameState.troops) {                const troop = gameState.troops[troopName];                const cost = calculateCost(troop.baseCost, troop.count, troop.costMultiplier);                                // Update cost display                const $costEl = document.getElementById(`${troopName}-cost`);                if ($costEl) $costEl.textContent = formatNumber(cost, 0);
                // Update count display                const $countEl = document.getElementById(`${troopName}-count`);                if ($countEl) $countEl.textContent = formatNumber(troop.count, 0);
                // Update button disable state                const $buyBtn = document.getElementById(`buy-${troopName}`);                if ($buyBtn) {                    $buyBtn.disabled = gameState.pancakes < cost;                    $buyBtn.classList.toggle('opacity-50', $buyBtn.disabled);                    $buyBtn.classList.toggle('cursor-not-allowed', $buyBtn.disabled);                }            }        }
        function updateDisplay() {            // Update main score, Gems, and PPS            $pancakesCount.textContent = formatNumber(gameState.pancakes, 2);            $gemsCount.textContent = formatNumber(gameState.gems, 0);            $ppsCount.textContent = formatNumber(gameState.pps, 1);            $clickValueDisplay.textContent = formatNumber(gameState.clickValue, 0);                        // Update special upgrade UIs            calculateStats();            updateSpecialUpgradesUI();                        // Since we're using onSnapshot, only manually save state on user actions            if (authReady) {                 // Save state every time the display updates (after user action)                 savePlayerStateToFirestore();             }        }
        // Handles visibility and disabled state for one-time purchases (Mega Knight, Auto Clicker, Gem)        function updateSpecialUpgradesUI() {            // --- Buy Gem UI ---            const $buyGem = document.getElementById('buy-gem');            if ($buyGem) {                const cost = gameState.gemCost;                $buyGem.disabled = gameState.pancakes < cost;                $buyGem.classList.toggle('opacity-50', $buyGem.disabled);                $buyGem.classList.toggle('cursor-not-allowed', $buyGem.disabled);                                const $costEl = $buyGem.querySelector('span');                if ($costEl) $costEl.textContent = `${formatNumber(cost, 0)} `;            }
            // --- Auto Clicker UI ---            const $buyAutoclicker = document.getElementById('buy-autoclicker');            if ($buyAutoclicker) {                if (gameState.autoClickerActive) {                    $buyAutoclicker.textContent = "ACTIVATED";                    $buyAutoclicker.disabled = true;                } else {                    const cost = gameState.autoClickerCost;                    $buyAutoclicker.disabled = gameState.pancakes < cost;                }                $buyAutoclicker.classList.toggle('opacity-50', $buyAutoclicker.disabled);                $buyAutoclicker.classList.toggle('cursor-not-allowed', $buyAutoclicker.disabled);            }                        // --- Mega Knight UI ---            const $buyMegaKnight = document.getElementById('buy-megaKnight');            const $megaKnightCount = document.getElementById('megaKnight-count');            if ($buyMegaKnight) {                if (gameState.megaKnightMultiplier > 1) {                    $buyMegaKnight.textContent = `ACTIVATED (x${MEGA_KNIGHT_MULTIPLIER_VALUE})`;                    $buyMegaKnight.disabled = true;                    if ($megaKnightCount) $megaKnightCount.textContent = `Yes (x${MEGA_KNIGHT_MULTIPLIER_VALUE})`;                } else {                    const cost = gameState.megaKnightCost;                    $buyMegaKnight.disabled = gameState.pancakes < cost;                    if ($megaKnightCount) $megaKnightCount.textContent = 'No';                }                $buyMegaKnight.classList.toggle('opacity-50', $buyMegaKnight.disabled);                $buyMegaKnight.classList.toggle('cursor-not-allowed', $buyMegaKnight.disabled);            }        }

        function showMessage(message, duration = 2000) {            $messageBox.textContent = message;            $messageBox.classList.remove('hidden');            setTimeout(() => {                $messageBox.classList.add('hidden');            }, duration);        }
        function formatNumber(num, decimalPlaces) {            if (num >= 1000000000) {                return (num / 1000000000).toFixed(2).replace(/\.0+$/, '') + 'B';            }            if (num >= 1000000) {                return (num / 1000000).toFixed(2).replace(/\.0+$/, '') + 'M';            }            if (num >= 1000) {                return (num / 1000).toFixed(1).replace(/\.0+$/, '') + 'K';            }            // Fallback for smaller numbers            return num.toFixed(decimalPlaces);        }
        // --- USER INTERACTIONS ---
        function clickPekka() {            gameState.pancakes += gameState.clickValue;            updateDisplay();                        // Simple visual feedback (pop-up score)            const popup = document.createElement('div');            popup.textContent = `+${formatNumber(gameState.clickValue, 0)} `;            popup.className = 'absolute text-4xl font-extrabold text-yellow-300 pointer-events-none transition-all duration-1000 ease-out opacity-0';                        // Position the popup near the clicker (centered on PEKKA)            const rect = $pekkaClicker.getBoundingClientRect();            popup.style.left = `${rect.left + rect.width / 2}px`;            popup.style.top = `${rect.top + rect.height / 2}px`;                        document.body.appendChild(popup);
            // Trigger animation            requestAnimationFrame(() => {                popup.style.transform = 'translateY(-50px) translateX(-50%)';                popup.style.opacity = '1';                setTimeout(() => {                    popup.style.opacity = '0';                    setTimeout(() => popup.remove(), 500); // Remove after fading out                }, 100);            });        }                function buyGem() {            const cost = gameState.gemCost;
            if (gameState.pancakes >= cost) {                gameState.pancakes -= cost;                gameState.gems += 1;                                updateDisplay();
                showMessage("You exchanged Pancakes for 1 Gem! Check the leaderboard!", 3000);
            } else {                showMessage(`Not enough Pancakes! Need ${formatNumber(cost - gameState.pancakes, 2)} more to buy a Gem.`, 2000);            }        }
        // Function for the one-time AFK Auto Clicker purchase        function buyAutoClicker() {            const cost = gameState.autoClickerCost;
            if (gameState.autoClickerActive) {                 showMessage("The Premium AFK Clicker is already active!", 2000);                 return;            }
            if (gameState.pancakes >= cost) {                gameState.pancakes -= cost;                gameState.autoClickerActive = true;                                updateDisplay();
                showMessage("Premium AFK Clicker activated! Your Mini P.E.K.K.A. is now clicking 24/7!", 3000);
            } else {                showMessage(`Not enough Pancakes! Need ${formatNumber(cost - gameState.pancakes, 2)} more .`, 2000);            }        }

        function buyTroop(troopName) {                        // Special logic for Mega Knight (one-time multiplier)            if (troopName === 'megaKnight') {                const cost = gameState.megaKnightCost;
                if (gameState.megaKnightMultiplier > 1) {                    showMessage("The Mega Knight multiplier is already active!", 2000);                    return;                }
                if (gameState.pancakes >= cost) {                    gameState.pancakes -= cost;                    gameState.megaKnightMultiplier = MEGA_KNIGHT_MULTIPLIER_VALUE; // Apply the multiplier                                        calculateStats(); // Recalculate PPS and Click Value                    updateDisplay();
                    showMessage("Mega Knight deployed! All your pancake earnings are now multiplied by x5!", 4000);                } else {                    showMessage(`Not enough Pancakes! Need ${formatNumber(cost - gameState.pancakes, 2)} more .`, 2000);                }                return;             }                        // Standard troop logic            const troop = gameState.troops[troopName];            if (!troop) return showMessage("Error: Troop not found.", 3000);
            const cost = calculateCost(troop.baseCost, troop.count, troop.costMultiplier);
            if (gameState.pancakes >= cost) {                gameState.pancakes -= cost;                troop.count++;                                // Recalculate stats and update display                calculateStats();                updateDisplay();
                showMessage(`Purchased 1 ${troopName.replace('_', ' ')}! Current PPS: ${formatNumber(gameState.pps, 1)}`, 1500);
            } else {                showMessage(`Not enough Pancakes! Need ${formatNumber(cost - gameState.pancakes, 2)} more .`, 2000);            }        }
        async function resetGame() {            // Using a custom confirmation message box instead of window.confirm            const customConfirm = (message, callback) => {                const modal = document.createElement('div');                modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';                modal.innerHTML = `                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-80">                        <p class="text-white mb-4">${message}</p>                        <div class="flex justify-end space-x-3">                            <button id="cancel-btn" class="py-2 px-4 bg-gray-600 rounded text-white hover:bg-gray-500">Cancel</button>                            <button id="confirm-btn" class="py-2 px-4 bg-red-600 rounded text-white hover:bg-red-500">Reset</button>                        </div>                    </div>                `;                document.body.appendChild(modal);
                document.getElementById('confirm-btn').onclick = () => {                    document.body.removeChild(modal);                    callback(true);                };                document.getElementById('cancel-btn').onclick = () => {                    document.body.removeChild(modal);                    callback(false);                };            };

            customConfirm("Are you sure you want to reset all progress? This will reset your progress in the global leaderboard!", async (result) => {                if (result) {                                        // Reset to initial state                    gameState = {                        pancakes: 0,                        gems: 0,                         baseClickValue: 1,                         clickValue: 1,                             pps: 0,                        autoClickerActive: false,                         megaKnightMultiplier: 1,                          username: gameState.username, // Keep the current username                        troops: {                            goblin: { count: 0, baseCost: 10, costMultiplier: 1.15, ppsPerUnit: 0.2 },                            wizard: { count: 0, baseCost: 100, costMultiplier: 1.25, ppsPerUnit: 2.0 },                            pekka: { count: 0, baseCost: 1000, costMultiplier: 1.35, ppsPerUnit: 20.0 }                        },                        megaKnightCost: 100000,                        autoClickerCost: 39900,                        gemCost: 10000                     };
                    await savePlayerStateToFirestore();                    updateDisplay();                    showMessage("Game reset! Start clicking the Mini P.E.K.K.A.!", 3000);                }            });        }                // --- GAME LOOP ---                function gameLoop() {            let passiveIncomeGenerated = false;                        // 1. PPS Income            if (gameState.pps > 0) {                gameState.pancakes += gameState.pps;                passiveIncomeGenerated = true;            }
            // 2. Auto Clicker Income (NEW)            if (gameState.autoClickerActive) {                 // The auto clicker simulates one click (gameState.clickValue) per second                gameState.pancakes += gameState.clickValue;                 passiveIncomeGenerated = true;            }                        // Only update display and save if some passive income was generated AND auth is ready            if (passiveIncomeGenerated) {                // Only update visual display on interval, save happens on click/buy                $pancakesCount.textContent = formatNumber(gameState.pancakes, 2);                $ppsCount.textContent = formatNumber(gameState.pps, 1);                                // Save state less frequently during passive play                if (authReady && (Math.floor(Date.now() / 1000) % 5 === 0)) { // Save every 5 seconds                    savePlayerStateToFirestore();                }            }        }                // Set the game loop to run once per second (1000ms)        const gameInterval = setInterval(gameLoop, 1000);                // --- EVENT LISTENERS & INITIALIZATION ---                $pekkaClicker.addEventListener('click', clickPekka);                // Initial load        window.onload = initFirebase;
    </script></body></html>
